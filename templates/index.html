<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastDanbooruDataset</title>
    <style>
        :root {
            --primary-color: #ff9a9e;
            --secondary-color: #4a90e2;
            --accent-color: #ff6b81;
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --text-color: #333333;
            --border-color: #ff9a9e;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .tool-btn {
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tool-btn.active {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        .tool-btn:hover {
            opacity: 0.9;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            flex: 1;
            height: 100vh;
            overflow: hidden;
        }

        /* Common Panel Styles */
        .panel {
            background: var(--panel-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 700;
            color: var(--secondary-color);
            font-size: 1.3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fcfcfc;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Left Sidebar */
        .sidebar-left {
            width: 320px;
            min-width: 320px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .section-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .section-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subsection-title {
            display: block;
            margin-bottom: 8px;
            font-size: 1rem;
            color: var(--secondary-color);
            font-weight: 600;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 1rem;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            background-color: var(--primary-color);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Button Active State for Blue Background */
        .btn:active, .btn.running {
            background-color: var(--secondary-color) !important;
            border-color: var(--secondary-color) !important;
            color: white !important;
            transform: translateY(1px);
        }

        .btn-secondary {
            background-color: var(--primary-color);
            border: 1px solid var(--primary-color);
            color: white;
        }

        .btn-secondary:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            width: auto;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
        }
        
        .action-group {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            margin-bottom: 10px;
        }
        
        .action-group .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .action-group .btn {
            width: auto;
            white-space: nowrap;
            height: 38px;
        }

        /* Status Indicators */
        .status-val {
            font-weight: 500;
        }
        
        .text-blue { color: var(--secondary-color); }
        .text-green { color: #27ae60; }
        .text-red { color: var(--accent-color); }

        /* Center Content */
        .main-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            position: relative;
        }

        .preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header {
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fcfcfc;
            min-height: 40px;
        }
        
        .section-header span {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
        }

        .image-viewer {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            background-color: #eef2f5;
            background-image: 
                linear-gradient(45deg, #e4e7eb 25%, transparent 25%), 
                linear-gradient(-45deg, #e4e7eb 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #e4e7eb 75%), 
                linear-gradient(-45deg, transparent 75%, #e4e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .image-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            border-radius: 4px;
            transition: transform 0.2s;
        }
        
        .empty-state {
            text-align: center;
            color: var(--secondary-color);
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .tags-editor {
            height: 200px;
            min-height: 150px;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .tags-textarea {
            flex: 1;
            width: 100%;
            padding: 15px;
            border: none;
            resize: none;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.95rem;
            line-height: 1.5;
            outline: none;
        }
        
        .tags-textarea:focus {
            background: #fefefe;
            box-shadow: inset 0 0 0 2px var(--secondary-color);
        }

        /* Right Sidebar */
        .sidebar-right {
            width: 280px;
            min-width: 250px;
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background: white;
        }

        .file-tree {
            padding: 10px 0;
        }

        .tree-item {
            padding: 6px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #444;
            user-select: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 3px solid transparent;
        }

        .tree-item:hover {
            background-color: #fff0f3;
            color: var(--secondary-color);
        }

        .tree-item.active {
            background-color: #fff0f3;
            color: var(--secondary-color);
            font-weight: 600;
            border-left: 3px solid var(--primary-color);
        }

        .tree-item-icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
            color: var(--primary-color);
            font-size: 0.8rem;
        }
        
        .tree-children {
            padding-left: 18px;
            display: none;
        }
        
        .tree-children.open {
            display: block;
        }
        
        .folder-toggle {
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            margin-right: 2px;
            font-size: 0.7rem;
            color: var(--primary-color);
            transition: transform 0.2s;
        }
        
        .folder-toggle.expanded {
            transform: rotate(90deg);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            font-size: 0.9rem;
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }

        /* Utility */
        .hidden { display: none !important; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ccc; 
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #bbb; 
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar: Interaction Area -->
        <aside class="sidebar-left panel">
            <div class="panel-header">
                <span>ÊéßÂà∂Èù¢Êùø</span>
            </div>
            <div class="panel-content">
                <!-- Download Section -->
                <div class="section-card">
                    <div class="section-title" style="font-size: 1.15rem; font-weight: 700;">Êï∞ÊçÆÈõÜ‰∏ãËΩΩ</div>
                    <div class="form-group">
                        <label for="tag" style="font-size: 1rem; color: #333; font-weight: 600;">Tag (ÂÖ≥ÈîÆËØç)</label>
                        <input type="text" id="tag" placeholder="‰æãÂ¶Ç: 1girl, black_hair">
                    </div>
                    <div class="form-group">
                        <label for="max_count" style="font-size: 1rem; color: #333; font-weight: 600;">ÊúÄÂ§ßÊï∞Èáè</label>
                        <input type="number" id="max_count" value="50" min="1" max="1000">
                    </div>
                    <div class="form-group">
                        <button id="start-btn" class="btn btn-primary">ÂºÄÂßã‰∏ãËΩΩ</button>
                        <button id="cancel-btn" class="btn btn-danger hidden">ÂèñÊ∂à‰∏ãËΩΩ</button>
                    </div>
                    <div class="status-indicator">
                         <span id="status" class="status-val">Â∞±Áª™</span>
                    </div>
                </div>

                <!-- Post Process Section -->
                <div class="section-card">
                    <div class="section-title" style="font-size: 1.15rem; font-weight: 700;">Êï∞ÊçÆÈõÜÂêéÂ§ÑÁêÜ</div>
                    <div class="form-group">
                        <label for="process-folder" style="display: block; margin-bottom: 8px; font-size: 1rem; color: #333; font-weight: 600;">ÁõÆÊ†áÊñá‰ª∂Â§π</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="process-folder" placeholder="dataset/tag_name">
                            <button id="refresh-folders-btn" class="btn btn-secondary btn-sm" title="Ëá™Âä®Â°´ÂÖÖ">üîÑ</button>
                        </div>
                    </div>
                    
                    <div class="subsection-title" style="margin-top: 20px; font-size: 1rem; color: #333; font-weight: 600;">Âü∫Á°ÄÊâπÈáèÊìç‰Ωú</div>
                    
                    <div class="btn-group" style="margin-bottom: 15px;">
                        <button id="rename-files-btn" class="btn btn-secondary btn-sm">Êñá‰ª∂ÈáçÂëΩÂêç</button>
                        <button id="auto-standardize-btn" class="btn btn-secondary btn-sm">TagÊ†áÂáÜÂåñ</button>
                    </div>

                    <div class="subsection-title" style="margin-top: 20px; font-size: 1rem; color: #333; font-weight: 600;">Ê†áÁ≠æÊâπÈáèÁºñËæë</div>

                    <div class="action-group-container">
                        <label style="font-size: 0.85rem; color: #555; font-weight: 400; margin-bottom: 3px;">Âà†Èô§ÊåáÂÆöÊ†áÁ≠æ</label>
                        <div class="action-group">
                            <div class="form-group">
                                 <input type="text" id="delete-tags" placeholder="‰æãÂ¶Ç: mosaic, text">
                            </div>
                            <button id="btn-delete-tags" class="btn btn-secondary btn-sm">ÊâßË°å</button>
                        </div>
                    </div>

                    <div class="action-group-container">
                        <label style="font-size: 0.85rem; color: #555; font-weight: 400; margin-bottom: 3px;">Âà†Èô§Ê®°Á≥äÊ†áÁ≠æ</label>
                        <div class="action-group">
                            <div class="form-group">
                                 <input type="text" id="delete-containing" placeholder="‰æãÂ¶Ç: hairÔºå blue">
                            </div>
                            <button id="btn-delete-containing" class="btn btn-secondary btn-sm">ÊâßË°å</button>
                        </div>
                    </div>
                    
                    <div class="action-group-container">
                        <label style="font-size: 0.85rem; color: #555; font-weight: 400; margin-bottom: 3px;">Ê∑ªÂä†Ê†áÁ≠æ</label>
                        <div class="action-group">
                            <div class="form-group">
                                 <input type="text" id="add-tags" placeholder="‰æãÂ¶Ç: artist:alice111Ôºå loli">
                            </div>
                            <button id="btn-add-tags" class="btn btn-secondary btn-sm">ÊâßË°å</button>
                       </div>
                   </div>

                   <div class="subsection-title" style="margin-top: 20px; font-size: 1rem; color: #333; font-weight: 600;">ÂõæÁâáÊâπÈáèÁºñËæë</div>

                   <div class="action-group-container">
                       <label style="font-size: 0.85rem; color: #555; font-weight: 400; margin-bottom: 3px;">Áº©ÊîæËá≥ÊúÄÂ§ßËæπ</label>
                       <div class="action-group">
                           <div class="form-group">
                                <input type="number" id="resize-max-edge" placeholder="‰æãÂ¶Ç: 1024" min="1">
                           </div>
                           <button id="btn-resize-images" class="btn btn-secondary btn-sm">ÊâßË°å</button>
                       </div>
                   </div>

                   <div class="action-group-container">
                       <label style="font-size: 0.85rem; color: #555; font-weight: 400; margin-bottom: 3px;">Ê∑ªÂä†ËÉåÊôØÂ∫ïËâ≤</label>
                       <div class="action-group">
                           <div class="form-group">
                                <select id="bg-color-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff;">
                                    <option value="white">ÁôΩËâ≤ (White)</option>
                                    <option value="gray">ÁÅ∞Ëâ≤ (Gray)</option>
                                </select>
                           </div>
                           <button id="btn-add-background" class="btn btn-secondary btn-sm">ÊâßË°å</button>
                       </div>
                   </div>
                   
                   <div id="process-result" class="status-indicator hidden" style="margin-top: 10px;">
                        <span id="process-result-text" class="status-val"></span>
                   </div>
                </div>
            </div>
        </aside>

        <!-- Center: Image Viewer & Tags -->
        <main class="main-center">
            <div class="panel-header">
                <span>ÊâãÂä®ÁºñËæë</span>
            </div>
            
            <!-- Image Preview Section -->
            <div class="preview-section">
                <div class="section-header" style="justify-content: flex-start; gap: 15px;">
                    <span>ÂõæÁâáÈ¢ÑËßà</span>
                    <div id="editor-toolbar" class="hidden" style="display: flex; gap: 8px; align-items: center; flex: 1;">
                        <div style="width: 1px; height: 20px; background: #ccc; margin: 0 5px;"></div>
                        <div class="btn-group">
                             <button class="btn btn-secondary btn-sm tool-btn active" id="tool-brush" title="ÁîªÁ¨î">ÁîªÁ¨î</button>
                             <button class="btn btn-secondary btn-sm tool-btn" id="tool-eraser" title="Ê©°ÁöÆ">Ê©°ÁöÆ</button>
                             <button class="btn btn-secondary btn-sm tool-btn" id="tool-eyedropper" title="Âê∏ÁÆ°">Âê∏ÁÆ°</button>
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px; margin-left: 5px;">
                            <input type="color" id="tool-color" value="#000000" title="È¢úËâ≤" style="height: 24px; width: 24px; padding: 0; border: none; cursor: pointer;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px; margin-left: 5px;">
                            <span style="font-size: 12px;">Size:</span>
                            <input type="range" id="tool-size" min="1" max="50" value="5" title="Â§ßÂ∞è" style="width: 80px;">
                            <span id="size-display" style="font-size: 12px; min-width: 25px;">5px</span>
                        </div>
                        <div style="width: 1px; height: 20px; background: #ccc; margin: 0 5px;"></div>
                        <button class="btn btn-secondary btn-sm tool-btn" id="tool-undo" title="Êí§Âõû (Ctrl+Z)">Êí§Âõû</button>
                        <div style="width: 1px; height: 20px; background: #ccc; margin: 0 5px;"></div>
                        <span id="image-resolution" style="font-size: 12px; color: #666;">- x -</span>
                        <div style="flex-grow: 1;"></div>
                        <button class="btn btn-primary btn-sm" id="save-image-btn" title="‰øùÂ≠òÂõæÁâá" style="padding: 4px 12px;">‰øùÂ≠òÂõæÁâá</button>
                    </div>
                </div>
                <div class="image-viewer" id="image-viewer" style="padding: 0; background-color: #eef2f5; background-image: linear-gradient(45deg, #e4e7eb 25%, transparent 25%), linear-gradient(-45deg, #e4e7eb 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #e4e7eb 75%), linear-gradient(-45deg, transparent 75%, #e4e7eb 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; overflow: hidden; position: relative;">
                    <div class="empty-state" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #888;">
                        <p>ËØ∑Âú®Âè≥‰æßÈÄâÊã©ÂõæÁâá</p>
                    </div>
                    
                    <div id="editor-container" class="hidden" style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
                        <canvas id="editor-canvas" style="background: transparent; display: block;"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="tags-editor">
                <div class="section-header">
                    <span>Ê†áÁ≠æÁºñËæë</span>
                    <div class="btn-group">
                        <button id="save-tags-btn" class="btn btn-primary btn-sm" disabled>‰øùÂ≠ò (Ctrl+S)</button>
                    </div>
                </div>
                <textarea id="tags-content" class="tags-textarea" placeholder="ÈÄâÊã©ÂõæÁâá‰ª•ÁºñËæëÊ†áÁ≠æ..." disabled></textarea>
            </div>
        </main>

        <!-- Right Sidebar: File Explorer -->
        <aside class="sidebar-right panel">
            <div class="panel-header">
                <span>Êñá‰ª∂ÂàóË°®</span>
                <button id="refresh-tree-btn" class="btn btn-secondary btn-sm" style="width: auto; padding: 4px 8px;">üîÑ</button>
            </div>
            <div class="panel-content" style="padding: 0;">
                <div id="file-tree" class="file-tree">
                    <div style="padding: 20px; text-align: center; color: #999;">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
        </aside>
    </div>

    <div id="toast" class="toast">Ê∂àÊÅØÊèêÁ§∫</div>

    <script>
        // State
        let currentImagePath = null;
        let isDownloading = false;
        let statusInterval = null;

        // Elements
        const el = {
            tag: document.getElementById('tag'),
            // downloadDir: document.getElementById('download_dir'), // Removed
            maxCount: document.getElementById('max_count'),
            startBtn: document.getElementById('start-btn'),
            cancelBtn: document.getElementById('cancel-btn'),
            status: document.getElementById('status'),
            
            processFolder: document.getElementById('process-folder'),
            
            renameFilesBtn: document.getElementById('rename-files-btn'),
            autoStandardizeBtn: document.getElementById('auto-standardize-btn'),
            
            deleteTags: document.getElementById('delete-tags'),
            btnDeleteTags: document.getElementById('btn-delete-tags'),
            
            deleteContaining: document.getElementById('delete-containing'),
            btnDeleteContaining: document.getElementById('btn-delete-containing'),
            
            addTags: document.getElementById('add-tags'),
            btnAddTags: document.getElementById('btn-add-tags'),
            
            resizeMaxEdge: document.getElementById('resize-max-edge'),
            btnResizeImages: document.getElementById('btn-resize-images'),
            bgColorSelect: document.getElementById('bg-color-select'),
            btnAddBackground: document.getElementById('btn-add-background'),
            
            refreshFoldersBtn: document.getElementById('refresh-folders-btn'),
            processResult: document.getElementById('process-result'),
            processResultText: document.getElementById('process-result-text'),
            
            imageViewer: document.getElementById('image-viewer'),
            editorContainer: document.getElementById('editor-container'),
            editorToolbar: document.getElementById('editor-toolbar'),
            canvas: document.getElementById('editor-canvas'),
            toolBrush: document.getElementById('tool-brush'),
            toolEraser: document.getElementById('tool-eraser'),
            toolEyedropper: document.getElementById('tool-eyedropper'),
            toolUndo: document.getElementById('tool-undo'),
            toolColor: document.getElementById('tool-color'),
            toolSize: document.getElementById('tool-size'),
            sizeDisplay: document.getElementById('size-display'),
            saveImageBtn: document.getElementById('save-image-btn'),
            imageResolution: document.getElementById('image-resolution'),
            
            tagsContent: document.getElementById('tags-content'),
            saveTagsBtn: document.getElementById('save-tags-btn'),
            fileTree: document.getElementById('file-tree'),
            refreshTreeBtn: document.getElementById('refresh-tree-btn'),
            toast: document.getElementById('toast')
        };

        // --- Toast Notification ---
        function showToast(message, type = 'info') {
            el.toast.textContent = message;
            el.toast.className = `toast show ${type}`;
            setTimeout(() => {
                el.toast.className = 'toast';
            }, 3000);
        }

        // --- File Tree Logic ---
        async function loadFileTree() {
            try {
                const response = await fetch('/api/dataset_structure');
                const data = await response.json();
                renderFileTree(data);
            } catch (error) {
                console.error('Failed to load file tree:', error);
                el.fileTree.innerHTML = '<div style="padding:15px;color:red;">Âä†ËΩΩÂ§±Ë¥•</div>';
            }
        }

        function renderFileTree(data) {
            el.fileTree.innerHTML = '';
            if (data.length === 0) {
                el.fileTree.innerHTML = '<div style="padding:15px;color:#999;text-align:center;">ÊöÇÊó†Êñá‰ª∂</div>';
                return;
            }
            
            const rootUl = document.createElement('div');
            data.forEach(item => {
                rootUl.appendChild(createTreeItem(item));
            });
            el.fileTree.appendChild(rootUl);
        }

        function createTreeItem(item) {
            const container = document.createElement('div');
            
            const row = document.createElement('div');
            row.className = 'tree-item';
            row.title = item.name;
            
            const icon = document.createElement('span');
            icon.className = 'tree-item-icon';
            
            const toggle = document.createElement('span');
            toggle.className = 'folder-toggle';
            
            if (item.type === 'directory') {
                toggle.textContent = '‚ñ∂';
                icon.innerHTML = '<span style="color:#4a90e2; font-size:1.2em;">‚ñ†</span>';
            } else {
                toggle.textContent = '';
                icon.innerHTML = '<span style="color:#ff9a9e; font-size:1.2em;">‚ñ°</span>';
            }
            
            row.appendChild(toggle);
            row.appendChild(icon);
            row.appendChild(document.createTextNode(item.name));
            
            container.appendChild(row);
            
            if (item.type === 'directory' && item.children) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children';
                
                item.children.forEach(child => {
                    childrenContainer.appendChild(createTreeItem(child));
                });
                
                container.appendChild(childrenContainer);
                
                // Toggle Event
                row.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = childrenContainer.classList.contains('open');
                    if (isOpen) {
                        childrenContainer.classList.remove('open');
                        toggle.classList.remove('expanded');
                    } else {
                        childrenContainer.classList.add('open');
                        toggle.classList.add('expanded');
                    }
                    
                    // Also populate process folder input if it's a directory
                    el.processFolder.value = item.path.replace(/\\/g, '/');
                });
            } else {
                // File Event
                row.addEventListener('click', () => {
                    // Remove active class from all
                    document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
                    row.classList.add('active');
                    openImage(item.path);
                });
            }
            
            return container;
        }

        el.refreshTreeBtn.addEventListener('click', loadFileTree);

        // --- Image Editor Logic ---
        const editor = {
            ctx: null,
            isDrawing: false,
            currentTool: 'brush', // brush, eraser, eyedropper
            lastX: 0,
            lastY: 0,
            scale: 1, // Current scale factor
            originalWidth: 0,
            originalHeight: 0,
            history: [],
            historyStep: -1,
            
            init() {
                if (!el.canvas) return;
                this.ctx = el.canvas.getContext('2d');
                
                // Event Listeners
                el.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                el.canvas.addEventListener('mousemove', (e) => this.draw(e));
                el.canvas.addEventListener('mouseup', () => this.stopDrawing());
                el.canvas.addEventListener('mouseout', () => this.stopDrawing());
                
                // Resize Observer to handle window resize
                const resizeObserver = new ResizeObserver(() => {
                    if (currentImagePath) {
                        this.fitToContainer();
                    }
                });
                resizeObserver.observe(el.imageViewer);
                
                // Tools
                el.toolBrush.addEventListener('click', () => this.setTool('brush'));
                el.toolEraser.addEventListener('click', () => this.setTool('eraser'));
                el.toolEyedropper.addEventListener('click', () => this.setTool('eyedropper'));
                el.toolUndo.addEventListener('click', () => this.undo());
                
                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        this.undo();
                    }
                });
                
                // Settings
                el.toolSize.addEventListener('input', (e) => {
                    el.sizeDisplay.textContent = e.target.value + 'px';
                });
                
                // Save Image
                el.saveImageBtn.addEventListener('click', () => this.saveImage());
            },
            
            saveHistory() {
                this.historyStep++;
                if (this.historyStep < this.history.length) {
                    this.history.length = this.historyStep;
                }
                this.history.push(el.canvas.toDataURL());
            },
            
            undo() {
                if (this.historyStep > 0) {
                    this.historyStep--;
                    const canvasPic = new Image();
                    canvasPic.src = this.history[this.historyStep];
                    canvasPic.onload = () => {
                        this.ctx.clearRect(0, 0, el.canvas.width, el.canvas.height);
                        this.ctx.drawImage(canvasPic, 0, 0);
                    }
                }
            },
            
            setTool(tool) {
                this.currentTool = tool;
                
                // Update UI
                el.toolBrush.classList.remove('active');
                el.toolEraser.classList.remove('active');
                el.toolEyedropper.classList.remove('active');
                el.canvas.style.cursor = 'crosshair';
                
                if (tool === 'brush') el.toolBrush.classList.add('active');
                else if (tool === 'eraser') {
                    el.toolEraser.classList.add('active');
                }
                else if (tool === 'eyedropper') {
                    el.toolEyedropper.classList.add('active');
                    el.canvas.style.cursor = 'copy';
                }
            },
            
            getMousePos(e) {
                const rect = el.canvas.getBoundingClientRect();
                return {
                    x: (e.clientX - rect.left) / this.scale,
                    y: (e.clientY - rect.top) / this.scale
                };
            },
            
            startDrawing(e) {
                if (this.currentTool === 'eyedropper') {
                    this.pickColor(e);
                    return;
                }
                
                this.isDrawing = true;
                const pos = this.getMousePos(e);
                this.lastX = pos.x;
                this.lastY = pos.y;
                
                this.draw(e);
            },
            
            draw(e) {
                if (!this.isDrawing) return;
                if (this.currentTool === 'eyedropper') return;
                
                const pos = this.getMousePos(e);
                const ctx = this.ctx;
                
                ctx.beginPath();
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.lineWidth = el.toolSize.value; // Scale line width? Maybe not needed if we draw on original resolution
                
                if (this.currentTool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out';
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = el.toolColor.value;
                }
                
                ctx.moveTo(this.lastX, this.lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                
                this.lastX = pos.x;
                this.lastY = pos.y;
            },
            
            stopDrawing() {
                if (this.isDrawing) {
                    this.isDrawing = false;
                    this.ctx.beginPath();
                    this.saveHistory();
                }
            },
            
            pickColor(e) {
                const pos = this.getMousePos(e);
                // Ensure coordinates are integers
                const x = Math.floor(pos.x);
                const y = Math.floor(pos.y);
                
                const pixel = this.ctx.getImageData(x, y, 1, 1).data;
                const r = pixel[0].toString(16).padStart(2, '0');
                const g = pixel[1].toString(16).padStart(2, '0');
                const b = pixel[2].toString(16).padStart(2, '0');
                const hex = `#${r}${g}${b}`;
                
                el.toolColor.value = hex;
                this.setTool('brush');
            },
            
            loadImage(src) {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    this.originalWidth = img.width;
                    this.originalHeight = img.height;
                    
                    // Set canvas actual resolution to match image
                    el.canvas.width = img.width;
                    el.canvas.height = img.height;
                    
                    // Update resolution display
                    if (el.imageResolution) {
                        el.imageResolution.textContent = `${img.width} x ${img.height}`;
                    }
                    
                    this.ctx.clearRect(0, 0, el.canvas.width, el.canvas.height);
                    this.ctx.drawImage(img, 0, 0);
                    
                    this.fitToContainer();
                    
                    // Reset History
                    this.history = [];
                    this.historyStep = -1;
                    this.saveHistory();
                };
                img.onerror = () => {
                     showToast('Êó†Ê≥ïÂä†ËΩΩÂõæÁâá', 'error');
                };
                img.src = src;
            },
            
            fitToContainer() {
                if (!this.originalWidth || !this.originalHeight) return;
                
                const containerWidth = el.imageViewer.clientWidth;
                const containerHeight = el.imageViewer.clientHeight;
                
                // Calculate scale to fit
                const scaleX = containerWidth / this.originalWidth;
                const scaleY = containerHeight / this.originalHeight;
                this.scale = Math.min(scaleX, scaleY); // Fit entirely
                
                // Apply visual scaling using CSS
                const displayWidth = this.originalWidth * this.scale;
                const displayHeight = this.originalHeight * this.scale;
                
                el.canvas.style.width = `${displayWidth}px`;
                el.canvas.style.height = `${displayHeight}px`;
            },
            
            async saveImage() {
                if (!currentImagePath) return;
                
                try {
                    el.saveImageBtn.disabled = true;
                    el.saveImageBtn.innerHTML = 'üíæ ‰øùÂ≠ò‰∏≠...';
                    
                    const dataURL = el.canvas.toDataURL('image/png');
                    
                    const response = await fetch('/api/save_image', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            image_path: currentImagePath,
                            image_data: dataURL
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast('ÂõæÁâáÂ∑≤‰øùÂ≠ò', 'success');
                    } else {
                        showToast('‰øùÂ≠òÂ§±Ë¥•: ' + result.message, 'error');
                    }
                } catch (error) {
                    showToast('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message, 'error');
                } finally {
                    el.saveImageBtn.disabled = false;
                    el.saveImageBtn.innerHTML = '‰øùÂ≠òÂõæÁâá';
                }
            }
        };
        
        editor.init();

        // --- Image & Tag Logic ---
        async function openImage(path) {
            currentImagePath = path;
            
            let servePath = path;
            if (path.startsWith('dataset/')) {
                servePath = path.substring(8); // "dataset/".length is 8
            }
            
            // Show editor
            document.querySelector('.empty-state').classList.add('hidden');
            el.editorContainer.classList.remove('hidden');
            el.editorToolbar.classList.remove('hidden');
            el.editorToolbar.style.display = 'flex'; // Ensure flex display
            
            // Load Image
            editor.loadImage(`/dataset/${servePath}`);
            
            // Load Tags
            el.tagsContent.value = 'Âä†ËΩΩ‰∏≠...';
            el.tagsContent.disabled = true;
            el.saveTagsBtn.disabled = true;
            
            try {
                const response = await fetch('/api/get_image_tags', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ image_path: path })
                });
                const result = await response.json();
                
                if (result.success) {
                    el.tagsContent.value = result.tags;
                    el.tagsContent.disabled = false;
                    el.saveTagsBtn.disabled = false;
                } else {
                    el.tagsContent.value = 'Êó†Ê≥ïÂä†ËΩΩÊ†áÁ≠æ: ' + result.message;
                }
            } catch (error) {
                el.tagsContent.value = 'Âä†ËΩΩÂá∫Èîô: ' + error.message;
            }
        }

        async function saveTags() {
            if (!currentImagePath) return;
            
            const content = el.tagsContent.value;
            el.saveTagsBtn.disabled = true;
            el.saveTagsBtn.textContent = '‰øùÂ≠ò‰∏≠...';
            
            try {
                const response = await fetch('/api/save_image_tags', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        image_path: currentImagePath,
                        tags: content
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Ê†áÁ≠æÂ∑≤‰øùÂ≠ò', 'success');
                } else {
                    showToast('‰øùÂ≠òÂ§±Ë¥•: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                el.saveTagsBtn.disabled = false;
                el.saveTagsBtn.textContent = '‰øùÂ≠ò (Ctrl+S)';
            }
        }

        el.saveTagsBtn.addEventListener('click', saveTags);
        
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (!el.saveTagsBtn.disabled) {
                    saveTags();
                }
            }
        });

        // --- Download Logic ---
        el.startBtn.addEventListener('click', async () => {
            const tag = el.tag.value.trim();
            const downloadDir = 'dataset'; // Hardcoded
            const maxCount = parseInt(el.maxCount.value) || 50;

            if (!tag) return showToast('ËØ∑ËæìÂÖ•Ê†áÁ≠æ', 'error');
            // if (!downloadDir) return showToast('ËØ∑ËæìÂÖ•‰∏ãËΩΩÁõÆÂΩï', 'error');

            try {
                el.startBtn.classList.add('running'); // Add running class
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ tag, download_dir: downloadDir, max_count: maxCount })
                });

                const result = await response.json();
                if (result.success) {
                    isDownloading = true;
                    updateUIState(true);
                    startStatusPolling();
                    showToast('ÂºÄÂßã‰∏ãËΩΩ...', 'info');
                } else {
                    showToast(result.message, 'error');
                    el.startBtn.classList.remove('running');
                }
            } catch (error) {
                showToast('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message, 'error');
                el.startBtn.classList.remove('running');
            }
        });

        el.cancelBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/cancel', { method: 'POST' });
                const result = await response.json();
                showToast(result.message, result.success ? 'success' : 'error');
                
                if (result.success) {
                    isDownloading = false;
                    updateUIState(false);
                    stopStatusPolling();
                }
            } catch (error) {
                showToast('ÂèñÊ∂àÂ§±Ë¥•: ' + error.message, 'error');
            }
        });

        function updateUIState(downloading) {
            if (downloading) {
                el.startBtn.classList.add('hidden');
                el.cancelBtn.classList.remove('hidden');
                el.status.classList.add('text-blue');
            } else {
                el.startBtn.classList.remove('hidden');
                el.cancelBtn.classList.add('hidden');
                el.status.classList.remove('text-blue');
                el.startBtn.classList.remove('running'); // Remove running when done
            }
        }

        function startStatusPolling() {
            statusInterval = setInterval(updateStatus, 1000);
        }

        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                el.status.textContent = status.status || 'Êú™Áü•';

                if (!status.is_downloading && isDownloading) {
                    isDownloading = false;
                    updateUIState(false);
                    stopStatusPolling();
                    showToast('‰∏ãËΩΩ‰ªªÂä°ÁªìÊùü', 'success');
                    loadFileTree(); // Refresh tree after download
                }
            } catch (error) {
                console.error('Status check failed', error);
            }
        }

        // --- Post Process Logic ---
        el.refreshFoldersBtn.addEventListener('click', () => {
            const downloadDir = 'dataset'; // Hardcoded
            const tag = el.tag.value.trim();
            if (tag) {
                el.processFolder.value = `${downloadDir}/${tag}`;
            }
        });

        // 1. Rename Files
        el.renameFilesBtn.addEventListener('click', async () => {
            const folder = el.processFolder.value.trim();
            if (!folder) return showToast('ËØ∑ÈÄâÊã©Â§ÑÁêÜÊñá‰ª∂Â§π', 'error');

            try {
                el.renameFilesBtn.disabled = true;
                el.renameFilesBtn.classList.add('running');
                const response = await fetch('/api/rename_files', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ folder_path: folder })
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    loadFileTree(); 
                } else {
                    showToast('ÈáçÂëΩÂêçÂ§±Ë¥•: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                el.renameFilesBtn.disabled = false;
                el.renameFilesBtn.classList.remove('running');
            }
        });

        // 2. Auto Standardize
        el.autoStandardizeBtn.addEventListener('click', async () => {
            const folder = el.processFolder.value.trim();
            if (!folder) return showToast('ËØ∑ÈÄâÊã©Â§ÑÁêÜÊñá‰ª∂Â§π', 'error');

            try {
                el.autoStandardizeBtn.disabled = true;
                el.autoStandardizeBtn.classList.add('running');
                const response = await fetch('/api/auto_standardize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ folder_path: folder })
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    loadFileTree();
                } else {
                    showToast('Ê†áÂáÜÂåñÂ§±Ë¥•: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                el.autoStandardizeBtn.disabled = false;
                el.autoStandardizeBtn.classList.remove('running');
            }
        });
        
        // Helper for Tag Processing
        async function processTags(data, btn) {
            const folder = el.processFolder.value.trim();
            if (!folder) return showToast('ËØ∑ÈÄâÊã©Â§ÑÁêÜÊñá‰ª∂Â§π', 'error');
            
            data.folder_path = folder;
            
            try {
                btn.disabled = true;
                btn.classList.add('running'); // Add running class for blue bg
                const response = await fetch('/api/manual_tag_process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                el.processResult.classList.remove('hidden');
                el.processResultText.textContent = result.message;
                el.processResultText.className = result.success ? 'status-val text-green' : 'status-val text-red';
                
                if (result.success) {
                    showToast('Êìç‰ΩúÂÆåÊàê', 'success');
                    if (currentImagePath && currentImagePath.includes(folder)) {
                        openImage(currentImagePath);
                    }
                }
            } catch (error) {
                showToast('Â§ÑÁêÜÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('running'); // Remove running class
            }
        }

        // 3. Delete Specific Tags
        el.btnDeleteTags.addEventListener('click', () => {
            const tags = el.deleteTags.value.trim();
            if (!tags) return showToast('ËØ∑Â°´ÂÜôË¶ÅÂà†Èô§ÁöÑÊ†áÁ≠æ', 'error');
            processTags({ remove_tags: tags.split(',') }, el.btnDeleteTags);
        });
        
        // 4. Delete Fuzzy Tags
        el.btnDeleteContaining.addEventListener('click', () => {
            const content = el.deleteContaining.value.trim();
            if (!content) return showToast('ËØ∑Â°´ÂÜôË¶ÅÂà†Èô§ÁöÑÂÜÖÂÆπ', 'error');
            processTags({ remove_containing: content.split(',') }, el.btnDeleteContaining);
        });

        // 5. Add Tags
        el.btnAddTags.addEventListener('click', () => {
            const tags = el.addTags.value.trim();
            if (!tags) return showToast('ËØ∑Â°´ÂÜôË¶ÅÊ∑ªÂä†ÁöÑÊ†áÁ≠æ', 'error');
            processTags({ add_tags: tags.split(',') }, el.btnAddTags);
        });

        // 6. Batch Resize
        el.btnResizeImages.addEventListener('click', () => {
             const maxEdge = el.resizeMaxEdge.value;
             if (!maxEdge) {
                 showToast('ËØ∑ËæìÂÖ•ÊúÄÂ§ßËæπÊï∞ÂÄº', 'error');
                 return;
             }
             batchProcessImages('resize', { max_edge: maxEdge }, el.btnResizeImages);
        });
        
        // 7. Batch Add Background
        el.btnAddBackground.addEventListener('click', () => {
             const color = el.bgColorSelect.value;
             batchProcessImages('add_background', { color: color }, el.btnAddBackground);
        });
        
        async function batchProcessImages(action, params, btn) {
             const folder = el.processFolder.value.trim();
             if (!folder) return showToast('ËØ∑ÂÖàÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π', 'error');
             
             if (btn) {
                 btn.disabled = true;
                 btn.classList.add('running');
             }
             
             el.processResult.classList.remove('hidden');
             el.processResultText.textContent = 'Â§ÑÁêÜ‰∏≠...';
             el.processResultText.className = 'status-val';
             
             try {
                 const response = await fetch('/api/batch_process_images', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({
                         folder_path: folder,
                         action: action,
                         params: params
                     })
                 });
                 
                 const result = await response.json();
                 
                 el.processResultText.textContent = result.message;
                 el.processResultText.className = result.success ? 'status-val text-green' : 'status-val text-red';
                 
                 if (result.success) {
                     showToast(result.message, 'success');
                     // If current image is in the folder, reload it
                     if (currentImagePath && currentImagePath.includes(folder)) {
                         let servePath = currentImagePath;
                         if (currentImagePath.startsWith('dataset/')) {
                             servePath = currentImagePath.substring(8);
                         }
                         // Force reload image
                         editor.loadImage(`/dataset/${servePath}?t=${Date.now()}`);
                     }
                 } else {
                     showToast('Êìç‰ΩúÂ§±Ë¥•: ' + result.message, 'error');
                 }
             } catch (e) {
                 el.processResultText.textContent = 'ËØ∑Ê±ÇÂ§±Ë¥•: ' + e.message;
                 el.processResultText.className = 'status-val text-red';
                 showToast('ËØ∑Ê±ÇÂ§±Ë¥•', 'error');
             } finally {
                 if (btn) {
                     btn.disabled = false;
                     btn.classList.remove('running');
                 }
             }
        }

        // Initialize
        updateStatus();
        loadFileTree();
    </script>
</body>
</html>